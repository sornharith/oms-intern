version: "3.8"

networks:
  loki:

services:
  postgres-account:
    image: "postgres:16-alpine"
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_DB: postgres
      POSTGRES_USER: postgres
    ports:
      - "5432:5432"
    volumes:
      - "pgdata_account:/var/lib/postgresql/data"

  account:
    build:
      context: ./account
      target: builder
    image: account
    env_file: account/.env
    expose:
      - "8080"
    ports:
      - "8080:8080"
    depends_on:
      - postgres-account
    volumes:
      - ./account:/go/src/app  # Mount your project directory into the container
    command: reflex -r "\.go$$" -s -- sh -c "go run ./"
  read:
    image: grafana/loki:3.0.0
    command: "-config.file=/etc/loki/config.yaml -target=read"
    ports:
      - 3101:3100
      - 7946
      - 9095
    volumes:
      - ./config/loki-config.yaml:/etc/loki/config.yaml
    depends_on:
      - minio
    healthcheck:
      test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks: &loki-dns
      loki:
        aliases:
          - loki

  write:
      image: grafana/loki:3.0.0
      command: "-config.file=/etc/loki/config.yaml -target=write"
      ports:
        - 3102:3100
        - 7946
        - 9095
      volumes:
        - ./config/loki-config.yaml:/etc/loki/config.yaml
      healthcheck:
        test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1" ]
        interval: 10s
        timeout: 5s
        retries: 5
      depends_on:
        - minio
      networks:
        <<: *loki-dns

    # alloy:
    #   image: grafana/alloy-dev:latest
    #   volumes:
    #     - ./alloy-local-config.yaml:/etc/alloy/config.alloy:ro
    #     - /var/run/docker.sock:/var/run/docker.sock
    #   command:  run --server.http.listen-addr=0.0.0.0:12345 --storage.path=/var/lib/alloy/data /etc/alloy/config.alloy
    #   ports:
    #     - 12345:12345
    #   depends_on:
    #     - gateway
    #   networks:
    #     - loki

  minio:
      image: minio/minio
      entrypoint:
        - sh
        - -euc
        - |
          mkdir -p /data/loki-data && \
          mkdir -p /data/loki-ruler && \
          minio server /data
      environment:
        - MINIO_ROOT_USER=loki
        - MINIO_ROOT_PASSWORD=supersecret
        - MINIO_PROMETHEUS_AUTH_TYPE=public
        - MINIO_UPDATE=off
      ports:
        - 9000
      volumes:
        - ./.data/minio:/data
      healthcheck:
        test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
        interval: 15s
        timeout: 20s
        retries: 5
      networks:
        - loki

  grafana:
      image: grafana/grafana:latest
      environment:
        - GF_PATHS_PROVISIONING=/etc/grafana/provisioning
        - GF_AUTH_ANONYMOUS_ENABLED=true
        - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      depends_on:
        - gateway
      entrypoint:
        - sh
        - -euc
        - |
          mkdir -p /etc/grafana/provisioning/datasources
          cat <<EOF > /etc/grafana/provisioning/datasources/ds.yaml
          apiVersion: 1
          datasources:
            - name: Loki
              type: loki
              access: proxy
              url: http://gateway:3100
              jsonData:
                httpHeaderName1: "X-Scope-OrgID"
              secureJsonData:
                httpHeaderValue1: "tenant1"
          EOF
          /run.sh
      ports:
        - "3000:3000"
      healthcheck:
        test: [ "CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1" ]
        interval: 10s
        timeout: 5s
        retries: 5
      networks:
        - loki

  backend:
      image: grafana/loki:3.0.0
      volumes:
        - ./config/loki-config.yaml:/etc/loki/config.yaml
      ports:
        - "3100"
        - "7946"
      command: "-config.file=/etc/loki/config.yaml -target=backend -legacy-read-mode=false"
      depends_on:
        - gateway
      networks:
        - loki


  gateway:
      image: nginx:latest
      depends_on:
        - read
        - write
      entrypoint:
        - sh
        - -euc
        - |
          cat <<EOF > /etc/nginx/nginx.conf
          user  nginx;
          worker_processes  5;  ## Default: 1

          events {
            worker_connections   1000;
          }

          http {
            resolver 127.0.0.11;

            server {
              listen             3100;

              location = / {
                return 200 'OK';
                auth_basic off;
              }

              location = /api/prom/push {
                proxy_pass       http://write:3100\$$request_uri;
              }

              location = /api/prom/tail {
                proxy_pass       http://read:3100\$$request_uri;
                proxy_set_header Upgrade \$$http_upgrade;
                proxy_set_header Connection "upgrade";
              }

              location ~ /api/prom/.* {
                proxy_pass       http://read:3100\$$request_uri;
              }

              location = /loki/api/v1/push {
                proxy_pass       http://write:3100\$$request_uri;
              }

              location = /loki/api/v1/tail {
                proxy_pass       http://read:3100\$$request_uri;
                proxy_set_header Upgrade \$$http_upgrade;
                proxy_set_header Connection "upgrade";
              }

              location ~ /loki/api/.* {
                proxy_pass       http://read:3100\$$request_uri;
              }
            }
          }
          EOF
          /docker-entrypoint.sh nginx -g "daemon off;"
      ports:
        - "3100:3100"
      healthcheck:
        test: [ "CMD", "service", "nginx", "status" ]
        interval: 10s
        timeout: 5s
        retries: 5
      networks:
        - loki

  promtail:
    image: grafana/promtail:2.5.0
    volumes:
      - ./config/promtail-config.yaml:/etc/promtail/config.yaml
      - ./account/logger/temp:/var/log
      - /var/run/docker.sock:/var/run/docker.sock
    command: -config.file=/etc/promtail/config.yaml
    networks:
      - loki

  init:
    image: &tempoImage grafana/tempo:latest
    user: root
    entrypoint:
      - "chown"
      - "10001:10001"
      - "/var/tempo"
    volumes:
      - ./tempo-data:/var/tempo
  tempo:
    image: *tempoImage
    command: [ "-config.file=/etc/tempo.yaml" ]
    volumes:
      - ../shared/tempo.yaml:/etc/tempo.yaml
      - ./tempo-data:/var/tempo
    ports:
      - "3200:3200"   # tempo
      - "9095:9095" # tempo grpc
      - "4317:4317"  # otlp grpc
      - "4318:4318"  # otlp http
    depends_on:
      - init
volumes:
  pgdata_account:

